{% extends 'layouts/base.html' %}
{% load add_input_validation %}
{% load static %}

{% block header %}
  
{% include 'includes/navigation.html' %}

{% endblock header %}

{% block content %}

<main>

    {% include 'includes/pre-loader.html' %} 

    <section class="min-vh-100 d-flex align-items-center section-image overlay-soft-dark" data-background="{% static 'assets/img/pages/login/login-bg.svg' %}">
        <div class="container mb mt-md-6">
            <div class="row justify-content-center">
                <div class="col-12 d-flex align-items-center justify-content-center">
                    <div class="signin-inner my-4 my-lg-0 bg-white shadow-soft border rounded border-gray-300 p-4 p-lg-5 w-100 fmxw-500">
                        <div class="text-center text-md-center mb-4 mt-md-0">
                            <img src="{% static 'assets/img/pages/login/favicon.ico' %}" alt="Logo" class="mb-3">
                            <h1 class="mb-0 h3">Sign in to our platform</h1>
                        </div>

                        <form method="post" class="mt-4" action="{% url 'login_with_otp' %}">
                            {% csrf_token %}
                            <div class="form-group mb-4">
                                <label for="username">Username</label>
                                <div class="input-group">
                                    <span class="input-group-text" id="basic-addon1">
                                        <span class="fas fa-user"></span>
                                    </span>
                                    <input type="text" id="username" name="username" class="form-control" placeholder="Enter your username">
                                </div>  
                                <span class="text-danger"> {{ form.username.errors|default_if_none:"" }} </span>
                            </div>


                            <div class="form-group mb-4">
                                <label for="password">Password</label>
                                <div class="input-group">
                                    <span class="input-group-text" id="basic-addon2">
                                        <span class="fas fa-unlock-alt"></span>
                                    </span>
                                    <input type="password" id="password" name="password" class="form-control" placeholder="Enter your password">
                                    <span class="input-group-text toggle-password" id="togglePassword">
                                        <span class="fas fa-eye"></span>
                                    </span>
                                </div>  
                                <span class="text-danger"> {{ form.password.errors|default_if_none:"" }} </span>
                            </div>

                            <!-- Hidden Recaptcha Input-->

                            <input type="hidden" name="g-recaptcha-response" id="g-recaptcha-response">

                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div class="form-check mb-0">
                                    <input class="form-check-input" type="checkbox" value="" id="remember">
                                    <label class="form-check-label mb-0" for="remember">
                                        Remember me
                                    </label>
                                </div>
                                <div><a href="{% url 'password_reset' %}" class="small text-right lost-password">Lost password?</a></div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-warning btn-primary">Sign in</button>
                            </div>
                        </form>

                        <div id="google-error" class="d-none alert alert-danger mt-3" role="alert"></div>
                        <div class="d-grid mt-3">
                            <button id="googleSignInBtn" type="button" class="btn btn-light border" style="background: #fff; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" alt="Google" style="width: 18px; height: 18px;">
                                <span>Sign in with Google</span>
                            </button>
                        </div>

                        <div class="text-center mt-3">
                            <a href="{% url 'passkey_login' %}" class="btn btn-secondary">Login with Passkey</a>
                        </div>

                        <div class="d-flex justify-content-center align-items-center mt-4">
                            <span class="fw-normal">
                                Not registered?
                                <a href="{% url 'signup' %}" class="fw-bold text-underline create-account">Create account</a>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    {% include 'includes/footer.html' %}
</main>

<script src="https://www.google.com/recaptcha/api.js?render={{ RECAPTCHA_SITE_KEY }}"></script>

<!-- Add JavaScript for password toggle -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const togglePassword = document.getElementById('togglePassword');
    const password = document.getElementById('password');
    
    togglePassword.addEventListener('click', function() {
        // Toggle the password field type
        const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
        password.setAttribute('type', type);
        
        // Toggle the eye icon
        this.querySelector('span').classList.toggle('fa-eye');
        this.querySelector('span').classList.toggle('fa-eye-slash');
    });
});

grecaptcha.ready(function () {
        grecaptcha.execute('{{ RECAPTCHA_SITE_KEY }}', {action: 'submit'})
        .then(function (token) {
            console.log("reCAPTCHA token generated onload:", token);
            document.getElementById('g-recaptcha-response').value = token;
        });
    });

// Google Sign-In with optimized loading and error handling
document.addEventListener('DOMContentLoaded', function() {
    var googleBtn = document.getElementById('googleSignInBtn');
    var originalBtnText = googleBtn ? googleBtn.innerHTML : '';
    var googleScriptLoaded = false;
    var googleScriptTimeout = null;

    function setLoading(isLoading) {
        if (!googleBtn) return;
        googleBtn.disabled = isLoading;
        if (isLoading) {
            googleBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Signing in...';
        } else {
            googleBtn.innerHTML = originalBtnText;
        }
    }

    function showError(message) {
        var holder = document.getElementById('google-error');
        if (!holder) return;
        holder.textContent = message || 'Google sign-in failed. Please try again.';
        holder.classList.remove('d-none');
        setTimeout(function(){ holder.classList.add('d-none'); holder.textContent=''; }, 6000);
    }

    function hideGoogleButton() {
        if (googleBtn) {
            googleBtn.style.display = 'none';
        }
    }

    function loadGoogleScript() {
        return new Promise(function(resolve, reject) {
            if (window.google && window.google.accounts && window.google.accounts.id) {
                resolve();
                return;
            }

            // Set timeout for script loading
            var timeout = setTimeout(function() {
                reject(new Error('Google script loading timeout'));
            }, 10000); // 10 second timeout

            var script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.async = true;
            script.defer = true;
            
            script.onload = function() {
                clearTimeout(timeout);
                // Wait a bit more for Google to initialize
                setTimeout(function() {
                    if (window.google && window.google.accounts && window.google.accounts.id) {
                        googleScriptLoaded = true;
                        resolve();
                    } else {
                        reject(new Error('Google library not properly initialized'));
                    }
                }, 500);
            };
            
            script.onerror = function() {
                clearTimeout(timeout);
                reject(new Error('Failed to load Google script'));
            };

            document.head.appendChild(script);
        });
    }

    function initializeGoogleSignIn() {
        return new Promise(function(resolve, reject) {
            try {
                if (!window.GOOGLE_CLIENT_ID) {
                    reject(new Error('Google client ID not configured'));
                    return;
                }

                google.accounts.id.initialize({
                    client_id: window.GOOGLE_CLIENT_ID,
                    callback: function(response) {
                        handleGoogleResponse(response);
                    }
                });
                resolve();
            } catch (e) {
                reject(e);
            }
        });
    }

    function handleGoogleResponse(response) {
        setLoading(true);
        
        // Set timeout for the entire authentication process
        var authTimeout = setTimeout(function() {
            showError('Authentication timeout. Please try again.');
            setLoading(false);
        }, 15000); // 15 second timeout

        fetch('{% url "google_login" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]') && document.querySelector('[name=csrfmiddlewaretoken]').value) || ''
            },
            body: JSON.stringify({ credential: response.credential })
        })
        .then(function(res) {
            clearTimeout(authTimeout);
            return res.json();
        })
        .then(function(data) {
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                showError(data.error || 'Google sign-in failed.');
                setLoading(false);
            }
        })
        .catch(function(e) {
            clearTimeout(authTimeout);
            console.error('Google authentication error:', e);
            showError('Network error during Google sign-in.');
            setLoading(false);
        });
    }

    if (googleBtn) {
        googleBtn.addEventListener('click', function() {
            if (!window.GOOGLE_CLIENT_ID) {
                showError('Google authentication not configured.');
                return;
            }

            setLoading(true);
            
            loadGoogleScript()
                .then(function() {
                    return initializeGoogleSignIn();
                })
                .then(function() {
                    google.accounts.id.prompt();
                    setLoading(false);
                })
                .catch(function(error) {
                    console.error('Google initialization error:', error);
                    showError('Google authentication is unavailable. Please try again later.');
                    setLoading(false);
                    hideGoogleButton();
                });
        });
    }
});
</script>

{% endblock content %}

{% block footer %}{% endblock footer %}